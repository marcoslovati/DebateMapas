<html>
    <head>
        <meta charset="utf-8">
        <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
        <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>        
        <link href="css/site.css" rel="stylesheet">
        <script src="js/site.js"></script>
        <script src="js/carregaMenu.js"></script>
        <title>Debate Mapas - Lista de debates</title>
    </head>
    <body>
        <div id="menu"></div>
        <div id="corpo" class="container">
            <h2>Lista de debates</h2>
            <p>Lista de debates criados pelo seu usuário</p>            
            <table id="table-debates" class="table">
            <thead>
                <tr>
                <th>Nome</th>
                <th>Data</th>
                <th>Ações</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
            </table>
        </div>
    </body>
</html>
<script>
    function liberarDebateResponder(id){
        var sucessoDebate = function(){
            exibeMensagem("Debate liberado para respostas com sucesso");
            buscarDebates(sucessoDebates);
        }

        alterarDebateParaRespostas(id, sucessoDebate);
    }

    var sucessoProcessarClusters = function(){
        exibeMensagem("Debate processado em clusters com sucesso");
        buscarDebates(sucessoDebates);
    };
    
    var sucessoProcessarNiveis = function(){
        exibeMensagem("Debate processado em níveis com sucesso");
        buscarDebates(sucessoDebates);
	};

    var sucessoDebates = function(debates){
        $("#table-debates>tbody").empty(); 
        debates.forEach(function(item) {
            var id = item._id;
            var data = new Date(item.created);
            var dataFormatada = data.getDate().toString().padStart(2,'0') + "/" + (data.getMonth() + 1).toString().padStart(2,'0') + "/" + data.getFullYear() + " " +
            data.getHours().toString().padStart(2,'0') + ":" + data.getMinutes().toString().padStart(2,'0');

            var botaoInicial = (!item.phase || item.phase === "P") ? ("<div style='display:inline; margin-right:5px' class='dropdown'><button class='btn btn-secondary dropdown-toggle' type='button' id='dropdownMenuButton' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>Definir grupos</button>" +
                "<ul class='dropdown-menu' aria-labelledby='dropdownMenuButton'>" +
                "<li><a onclick='processarNiveisDebateInicial(\"" + id + "\", sucessoProcessarNiveis)' href='#'>Com base no nível</a></li>" +
                "<li><a onclick='processarClustersDebateInicial(\"" + id + "\", sucessoProcessarClusters)' href='#'>Com base na semelhança</a></li></ul></div>") : "";

            var botaoRespostas = item.phase === "P" ? "<button id='liberaRespostas-" + id +"' style='margin-right:5px' onclick='liberarDebateResponder(\"" + id + "\")' class='btn btn-primary'>Liberar para respostas</button>" : "";

            var botaoResultado = item.phase === "R" ? "<button onclick='processarDebateFinal(\"" + id + "\")' class='btn btn-primary'>Calcular resultado</button>" : "";

            var itemDebate = "<tr><td>" + item.name + "</td><td>" + dataFormatada + "</td>" + 
                // "<td><button onclick='editarDebate(\"" + id + "\")' class='btn btn-deafult btn-list'>Editar</button>" +
                // "<button onclick='processarNiveisDebateInicial(\"" + id + "\")' class='btn btn-primary btn-list'>Definir questionadores</button>" + 
                "<td>" +
                botaoInicial +
                botaoRespostas +
                botaoResultado + 
                "</td></tr>";

            $("#table-debates>tbody").append(itemDebate);  
        });

    };

    buscarDebates(sucessoDebates);
</script>