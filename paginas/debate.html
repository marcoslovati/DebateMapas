<div class="form-group">
    <input type="text" name="nome" id="nome" tabindex="1" class="form-control" placeholder="Assunto do debate" value="">
</div>
<div class="panel panel-default">
    <div class="panel-heading">Selecione o seu mapa de referência para o debate</div>
    <div class="panel-body">
        <div id="lista-meus-mapas"></div>
    </div>
</div>
<div class="form-group">
    <select name="grupo" id="grupo" tabindex="1" class="form-control">        
    </select>
</div>
<div class="form-group">
    <input type="date" name="filtro-data" id="filtro-data" tabindex="1" class="form-control" placeholder="Data" value="">
    <button id="button-filtro">Buscar Mapas</button>
</div>
<div class="panel panel-default">
    <div class="panel-heading">Selecione os mapas que deseja incluir no debate</div>
    <div class="panel-body">
        <div id="lista-mapas"></div>
    </div>
</div>
<div class="form-group">
    <button id="button-salvar">Salvar</button>
</div>

<script>
    var grupos = [];
    var idsUsuarios = [];

    $("#button-filtro").click(function(){
        var sucessoCarregaLista = function (mapas){
            $('#lista-mapas').empty();            
            mapas.forEach(function(item){
                if(item.versions.length > 0){
                    var id = item._id;
                    var titulo = item.title;
                    var autor = item.author.username;
                    var versions = item.versions;

                    var itemMapa = "<div class='form-check'>" +
                        "<label id=" + id + " class='form-check-label'>Autor: " + autor + " Título: " + titulo + " Versões: </label></div>";
                    $('#lista-mapas').append(itemMapa);

                    versions.forEach(function(item2) {
                        var idVersao = item2._id;
                        var data = new Date(item2.created);
                        var dataFormatada = data.getDate().toString().padStart(2,'0') + '/' + (data.getMonth() + 1).toString().padStart(2,'0') + '/' + data.getFullYear() + ' ' +
                            data.getHours().toString().padStart(2,'0') + ':' + data.getMinutes().toString().padStart(2,'0');

                        var itemVersao = "<input style='margin-left:5px' class='form-check-input versao' type='checkbox' value='' id=" + idVersao + ">" + dataFormatada;
                        $('#'+id).append(itemVersao);
                    });
                }           
            });             
        };



        var grupoId = $("#grupo").val();
        grupos.forEach(element => {
            if(grupoId === element._id){
                element.users.forEach(user => {
                    idsUsuarios.push(user._id);
                });               
            }
        });

        buscarMapasPorGrupoEData($('#filtro-data').val(), idsUsuarios, sucessoCarregaLista);      
    });

    $("#button-salvar").click(function(){
        var sucessoDebateUnities = function(){
            carregarPagina("paginas/home.html");
        }

        var sucessoDebate = function (resposta){
            var debateUnities = [];
            console.log(resposta);

            $('input[type=checkbox].versao:checked').each(function(){                
                var versao = $(this).attr('id');                
                var debateUnity = {
                    "debate": {
                        "_id":resposta.debate._id,
                        "name": resposta.debate.name
                    },
                    "initialMapContent":{
                        "_id": versao
                    }
                };

                debateUnities.push(debateUnity);
            });

            salvarDebateUnities(debateUnities, sucessoDebateUnities);            
        };
        
        var nome = $("#nome").val();
        var versao = $('input[type=radio].versao:checked').attr('id');

        var debate = {
            "name":nome,
            "referenceMapContent":{
                "_id":versao
            }
        };

        salvarDebate(debate, sucessoDebate);        
    });

    function listarMeusMapas(){
        var sucessoCarregaLista = function (mapas){
            $('#lista-meus-mapas').empty();
            mapas.forEach(function(item){
                if(item.versions.length > 0){
                    var id = item._id;
                    var titulo = item.title;
                    var versions = item.versions;

                    var itemMapa = "<div class='form-check'>" +
                        "<label id=" + id + " class='form-check-label'>Título: " + titulo + " Versões: </label></div>";
                    $('#lista-meus-mapas').append(itemMapa);

                    versions.forEach(function(item2) {
                        var idVersao = item2._id;
                        var data = new Date(item2.created);
                        var dataFormatada = data.getDate().toString().padStart(2,'0') + '/' + (data.getMonth() + 1).toString().padStart(2,'0') + '/' + data.getFullYear() + ' ' +
                            data.getHours().toString().padStart(2,'0') + ':' + data.getMinutes().toString().padStart(2,'0');

                        var itemVersao = "<input style='margin-left:5px' class='form-radio-input versao' type='radio' name='radio-versao' value='' id=" + idVersao + ">" + dataFormatada;
                        $('#'+id).append(itemVersao);
                    });
                }           
            });             
        };

        buscarMapasPorAutor(sucessoCarregaLista);
    }

    var userId = localStorage.getItem("userId");
    
    var sucessoGrupos = function(grps){
        grupos = grps;
        $("#grupo").empty();
        grps.forEach(element => {
            var item = '<option value="'+ element._id +'">' + element.name + '</option>';
            $("#grupo").append(item);
        });
    };

    buscarGruposPorAdmin(userId, sucessoGrupos);

    listarMeusMapas();
</script>