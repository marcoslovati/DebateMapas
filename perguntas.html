<html>
    <head>
        <meta charset="utf-8">
        <script src="js/jquery.min.js"></script>
        <link href="css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <script src="js/bootstrap.min.js"></script>        
        <link href="css/site.css" rel="stylesheet">
        <script src="js/site.js"></script>
        <script src="js/gojs/go.js"></script>
        <script src="js/carregaMenu.js"></script>
        <title>Debate Mapas - Perguntas</title>
    </head>
    <body>
        <div id="menu"></div>
        <div id="corpo" class="container">
            <div>
                <h4 id="autor"></h4>
            </div>
            <div id="myDiagramDiv" style="height: 60%; border: 1px black solid"></div>

            <div style="margin-top: 20px">
                <div id="questoes"></div>
                <div style="margin-top: 20px" class="form-group text-right">
                    <button class="btn btn-default pull-left" id="button-adicionar">Adicionar questão</button>
                    <button class="btn btn-default" id="button-voltar">Voltar</button>
                    <button style="margin-left: 5px" class="btn btn-primary" id="button-salvar">Salvar</button>
                </div>
            </div>
        </div>
    </body>
</html>
<script>
    var Go = go.GraphObject.make;  // for conciseness in defining templates

    myDiagram =
      Go(go.Diagram, "myDiagramDiv",  // must name or refer to the DIV HTML element
        {
          // start everything in the middle of the viewport
          initialContentAlignment: go.Spot.Center,
          // have mouse wheel events zoom in and out instead of scroll up and down
          "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
          // support double-click in background creating a new node
          "clickCreatingTool.archetypeNodeData": { text: "new node" },
          // enable undo & redo
          "undoManager.isEnabled": false
        });

    // define the Node template
    myDiagram.nodeTemplate =
      Go(go.Node, "Auto",
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        // define the node's outer shape, which will surround the TextBlock
        Go(go.Shape, "RoundedRectangle",
          {
            parameter1: 20,  // the corner has a large radius
            fill: Go(go.Brush, "Linear", { 0: "rgb(254, 201, 0)", 1: "rgb(254, 162, 0)" }),
            stroke: null,
            portId: "",  // this Shape is the Node's port, not the whole Node
            fromLinkable: false, fromLinkableSelfNode: false, fromLinkableDuplicates: false,
            toLinkable: false, toLinkableSelfNode: false, toLinkableDuplicates: false
          }),
        Go(go.TextBlock,
          {
            font: "bold 11pt helvetica, bold arial, sans-serif",
            editable: false  // editing the text automatically updates the model data
          },
          new go.Binding("text").makeTwoWay())
      );

    // unlike the normal selection Adornment, this one includes a Button
    myDiagram.nodeTemplate.selectionAdornmentTemplate =
      Go(go.Adornment, "Spot",
        Go(go.Panel, "Auto",
          Go(go.Shape, { fill: null, stroke: "blue", strokeWidth: 2 }),
          Go(go.Placeholder)  // a Placeholder sizes itself to the selected Node
        )
      ); // end Adornment

    // replace the default Link template in the linkTemplateMap
    myDiagram.linkTemplate =
      Go(go.Link,  // the whole link panel
        {
          curve: go.Link.Bezier, adjusting: go.Link.Stretch,
          reshapable: false, relinkableFrom: false, relinkableTo: false,
          toShortLength: 3
        },
        new go.Binding("points").makeTwoWay(),
        new go.Binding("curviness"),
        Go(go.Shape,  // the link shape
          { strokeWidth: 1.5 }),
        Go(go.Shape,  // the arrowhead
          { toArrow: "standard", stroke: null }),
        Go(go.Panel, "Auto",
          Go(go.Shape,  // the label background, which becomes transparent around the edges
            {
              fill: Go(go.Brush, "Radial",
                      { 0: "rgb(240, 240, 240)", 0.3: "rgb(240, 240, 240)", 1: "rgba(240, 240, 240, 0)" }),
              stroke: null
            }),
          Go(go.TextBlock, "transition",  // the label text
            {
              textAlign: "center",
              font: "9pt helvetica, arial, sans-serif",
              margin: 4,
              editable: false  // enable in-place editing
            },
            // editing the text automatically updates the model data
            new go.Binding("text").makeTwoWay())
        )
      );

    $("#button-adicionar").click(function(){
        var d = new Date();

        var itemQuestao = "<div style='min-height:60px' class='form-group'><div class='col-md-11'><textarea placeholder='Questão' class='form-control questao'>" + 
        "</textarea></div><div class='col-md-1'><button class='btn btn-danger btn-excluir' id='button-excluir-" + d.getTime() + "'>Excluir</button></div></div>";

        $("#questoes").append(itemQuestao);
    });

    $(document).on("click", ".btn-excluir", function(){
        console.log($(this));
        $(this)[0].parentNode.parentNode.remove();
    });

    $("#button-salvar").click(function(){
        var questions = [];

        $(".questao").each(function(){
            var texto = $(this).val();
            console.log(texto);
            if(texto)
                questions.push({text: texto});
        }); 
        
        if(questions.length >= 2){
          var dados = {
              debateUnity: debateUnity,
              questions:questions
          };

          var sucessoDebateUnity = function(){
              exibeMensagem("Perguntas salvas com sucesso");
          }       

          atualizarDebateUnity(dados, sucessoDebateUnity);
        }
        else
          exibeMensagem("Atenção: adicione ao menos duas questões!", 2);
    });

    $("#button-voltar").click(function(){
        window.location = "listaDebatesPerguntar.html";
    });

    var debateUnity = JSON.parse(sessionStorage.getItem("debateUnity"));
    var userId = localStorage.getItem("userId");

    var questoes = (userId === debateUnity.questioner1._id ? debateUnity.questionsQuestioner1 : debateUnity.questionsQuestioner2);

    questoes.forEach(q =>{
        var d = new Date();
        var texto = q.text != null ? q.text : "";
        var itemQuestao = "<div style='min-height:60px' class='form-group'><div class='col-md-11'><textarea placeholder='Questão' class='form-control questao'>" + 
        q.text + "</textarea></div><div class='col-md-1'><button class='btn btn-danger btn-excluir' id='button-excluir-" + d.getTime() + "'>Excluir</button></div></div>";

        $("#questoes").append(itemQuestao);
    });

    var autor = debateUnity.debate.keepAuthorsAnonymous ? "(anônimo)" : debateUnity.mapsAuthor.username;

    $("#autor").html("Autor do mapa: " + autor);

    var sucessoMapContent = function(mapContent){
        myDiagram.model = go.Model.fromJson(mapContent.content);
    };

    buscarMapContent(debateUnity.initialMapContent._id, sucessoMapContent);
</script>