<html>
    <head>
        <meta charset="utf-8">
        <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
        <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>        
        <link href="css/site.css" rel="stylesheet">
        <script src="js/site.js"></script>
        <script src="js/gojs/go.js"></script>
        <script src="js/carregaMenu.js"></script>
        <title>Debate Mapas - Resposta</title>
    </head>
    <body>
        <div id="menu"></div>
        <div id="corpo" class="container">
            <div>
                <h4 id="questionador1"></h4>
                <div class="form-group">
                    <input type="text" readonly id="pergunta1" tabindex="1" class="form-control">
                </div>
                <div class="form-group">
                    <input type="text" readonly id="pergunta2" tabindex="2" class="form-control">
                </div>
            </div>
            <div>
                <h4 id="questionador2"></h4>
                <div class="form-group">
                    <input type="text" readonly id="pergunta3" tabindex="1" class="form-control">
                </div>
                <div class="form-group">
                    <input type="text" readonly id="pergunta4" tabindex="2" class="form-control">
                </div>
            </div>
            <div id="myDiagramDiv" style="width: 100%; height: 60%; border: 1px black solid"></div>
            <div class="form-group" style="padding-top: 20px;">
                <div class="row">
                    <div class="col-sm-12 text-right">
                        <button id="button-salvar" class="btn btn-primary" tabindex="2" disabled>Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script>
    var Go = go.GraphObject.make;  // for conciseness in defining templates

    myDiagram =
        Go(go.Diagram, "myDiagramDiv",  // must name or refer to the DIV HTML element
        {
            // start everything in the middle of the viewport
            initialContentAlignment: go.Spot.Center,
            // have mouse wheel events zoom in and out instead of scroll up and down
            "toolManager.mouseWheelBehavior": go.ToolManager.WheelZoom,
            // support double-click in background creating a new node
            "clickCreatingTool.archetypeNodeData": { text: "conceito" },
            // enable undo & redo
            "undoManager.isEnabled": true
        });

    // when the document is modified, add a "*" to the title and enable the "Save" button
    myDiagram.addDiagramListener("Modified", function(e) {
        var button = document.getElementById("button-salvar");
        if (button) button.disabled = !myDiagram.isModified;
        var idx = document.title.indexOf("*");
        if (myDiagram.isModified) {
        if (idx < 0) document.title += "*";
        } else {
        if (idx >= 0) document.title = document.title.substr(0, idx);
        }
    });

    // define the Node template
    myDiagram.nodeTemplate =
        Go(go.Node, "Auto",
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        // define the node's outer shape, which will surround the TextBlock
        Go(go.Shape, "RoundedRectangle",
            {
            parameter1: 20,  // the corner has a large radius
            fill: Go(go.Brush, "Linear", { 0: "rgb(254, 201, 0)", 1: "rgb(254, 162, 0)" }),
            stroke: null,
            portId: "",  // this Shape is the Node's port, not the whole Node
            fromLinkable: true, fromLinkableSelfNode: true, fromLinkableDuplicates: true,
            toLinkable: true, toLinkableSelfNode: true, toLinkableDuplicates: true,
            cursor: "pointer"
            }),
        Go(go.TextBlock,
            {
            font: "bold 11pt helvetica, bold arial, sans-serif",
            editable: true  // editing the text automatically updates the model data
            },
            new go.Binding("text").makeTwoWay())
        );

    // unlike the normal selection Adornment, this one includes a Button
    myDiagram.nodeTemplate.selectionAdornmentTemplate =
        Go(go.Adornment, "Spot",
        Go(go.Panel, "Auto",
            Go(go.Shape, { fill: null, stroke: "blue", strokeWidth: 2 }),
            Go(go.Placeholder)  // a Placeholder sizes itself to the selected Node
        ),
        // the button to create a "next" node, at the top-right corner
        Go("Button",
            {
            alignment: go.Spot.TopRight,
            click: addNodeAndLink  // this function is defined below
            },
            Go(go.Shape, "PlusLine", { width: 6, height: 6 })
        ) // end button
        ); // end Adornment

    // clicking the button inserts a new node to the right of the selected node,
    // and adds a link to that new node
    function addNodeAndLink(e, obj) {
        var adornment = obj.part;
        var diagram = e.diagram;
        diagram.startTransaction("Add State");

        // get the node data for which the user clicked the button
        var fromNode = adornment.adornedPart;
        var fromData = fromNode.data;
        // create a new "State" data object, positioned off to the right of the adorned Node
        var toData = { text: "conceito" };
        var p = fromNode.location.copy();
        p.x += 200;
        toData.loc = go.Point.stringify(p);  // the "loc" property is a string, not a Point object
        // add the new node data to the model
        var model = diagram.model;
        model.addNodeData(toData);

        // create a link data from the old node data to the new node data
        var linkdata = {
        from: model.getKeyForNodeData(fromData),  // or just: fromData.id
        to: model.getKeyForNodeData(toData),
        text: "relação"
        };
        // and add the link data to the model
        model.addLinkData(linkdata);

        // select the new Node
        var newnode = diagram.findNodeForData(toData);
        diagram.select(newnode);

        diagram.commitTransaction("Add State");

        // if the new node is off-screen, scroll the diagram to show the new node
        diagram.scrollToRect(newnode.actualBounds);
    }

    // replace the default Link template in the linkTemplateMap
    myDiagram.linkTemplate =
        Go(go.Link,  // the whole link panel
        {
            curve: go.Link.Bezier, adjusting: go.Link.Stretch,
            reshapable: true, relinkableFrom: true, relinkableTo: true,
            toShortLength: 3
        },
        new go.Binding("points").makeTwoWay(),
        new go.Binding("curviness"),
        Go(go.Shape,  // the link shape
            { strokeWidth: 1.5 }),
        Go(go.Shape,  // the arrowhead
            { toArrow: "standard", stroke: null }),
        Go(go.Panel, "Auto",
            Go(go.Shape,  // the label background, which becomes transparent around the edges
            {
                fill: Go(go.Brush, "Radial",
                        { 0: "rgb(240, 240, 240)", 0.3: "rgb(240, 240, 240)", 1: "rgba(240, 240, 240, 0)" }),
                stroke: null
            }),
            Go(go.TextBlock, "relação",  // the label text
            {
                textAlign: "center",
                font: "9pt helvetica, arial, sans-serif",
                margin: 4,
                editable: true  // enable in-place editing
            },
            // editing the text automatically updates the model data
            new go.Binding("text").makeTwoWay())
        )
        );    

    var mapId;
    var debateUnity = JSON.parse(sessionStorage.getItem("debateUnity"));

    $("#button-salvar").click(function(){
        var conteudo = myDiagram.model.toJson();

        salvarMapaFinal(mapId, conteudo, debateUnity);
        exibeMensagem("Mapa salvo com sucesso");
    });
    
    $("#questionador1").html(debateUnity.questioner1.username);
    $("#pergunta1").val(debateUnity.question1);
    $("#pergunta2").val(debateUnity.question2);

    $("#questionador2").html(debateUnity.questioner2.username);
    $("#pergunta3").val(debateUnity.question3);
    $("#pergunta4").val(debateUnity.question4);    

    
    var sucessoMapContent = function(mapContent){
        myDiagram.model = go.Model.fromJson(mapContent.content);
        mapId = mapContent.map._id;
    };

    var idMapContent;
    if(debateUnity.finalMapContent){
        idMapContent = debateUnity.finalMapContent._id;
    }
    else{
        idMapContent = debateUnity.initialMapContent._id;
    }        

    buscarMapContent(idMapContent, sucessoMapContent);
</script>